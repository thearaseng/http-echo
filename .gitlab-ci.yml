stages:
  - compile
  - build
  - env_var

variables:
  DOMAIN_NAME: wingecosys.com
  SERVICE_NAME: "$CI_PROJECT_NAME"
  DOCKER_REGISTRY: "$AWS_ECR"

build-jar:
  stage: compile
  image: gradle:jdk8
  only:
    - dev
  script:
    - gradle bootjar -x test
    - rm -f build/libs/*-plain.jar
    - mv build/libs/$(ls build/libs) app.jar
  artifacts:
    paths:
      - app.jar

docker-build:
  stage: build
  image:
    name: public.ecr.aws/b1t9u1a9/awscli:0.0.1
  before_script:
    - VERSION=$(cat version.properties || echo '0.0.1' | sed 's/.*VERSION=//')
    - VERSION=$VERSION-$CI_COMMIT_SHORT_SHA
  script:
    - aws ecr get-login-password | docker login --username AWS --password-stdin $DOCKER_REGISTRY
    - docker build -t $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_REF_NAME.${VERSION} .
    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_REF_NAME.${VERSION}
  only:
    - dev

include: '/.gitlab/deployment.yml'